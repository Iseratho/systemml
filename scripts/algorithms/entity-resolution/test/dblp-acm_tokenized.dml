#-------------------------------------------------------------
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
#-------------------------------------------------------------

source("./scripts/algorithms/entity-resolution/primitives/matching.dml") as match;
source("./scripts/algorithms/entity-resolution/primitives/postprocessing.dml") as post;
source("./scripts/algorithms/entity-resolution/primitives/preprocessing.dml") as pre;

acm = read("./data/DBLP-ACM/ACM_tokens.csv");
dblp = read("./data/DBLP-ACM/DBLP2_tokens.csv");
gt = read("./data/DBLP-ACM/DBLP-ACM_perfectMapping.csv");

acm_class = as.frame(matrix(0, rows=nrow(acm), cols=1));
dblp_class = as.frame(matrix(1, rows=nrow(dblp), cols=1));

acm = cbind(acm, acm_class);
dblp = cbind(dblp, dblp_class);

n_acm = nrow(acm);
n_dblp = nrow(dblp);

FX = rbind(acm, dblp);

# convert_frame_tokens_to_matrix_bow
[X, MX] = pre::convert_frame_tokens_to_matrix_bow(FX);

write(MX, "./data/DBLP-ACM/DBLP-ACM_MX.csv");

n_col = ncol(X);
n_row = n_acm + n_dblp;
SIM = match::cosine2(X[n_acm+1:n_row,2:n_col], X[1:n_acm,2:n_col]);
THRES = match::tresholding(SIM, 0.9);

sparse = post::untable_offset(THRES, row_offset=n_acm, col_offset=0);
dense = table(sparse[,1], sparse[,2]);

dec = transformdecode(target=sparse, meta=cbind(MX[,1],MX[,1]), spec="{recode:[C1,C2]}");
output = cbind(dec, as.frame(sparse[,3]));
print(toString(output, rows=10));
write(output, "./data/DBLP-ACM/DBLP-ACM_res.csv", sep=",", sparse=FALSE, format="csv");
